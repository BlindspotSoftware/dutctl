syntax = "proto3";

package dutctl.v1;

option go_package = "github.com/BlindspotSoftware/dutctl/protobuf/gen/dutctl/v1;dutctlv1";

// DeviceService defines the service for interacting with devices.
service DeviceService {
  rpc List(ListRequest) returns (ListResponse) {}
  rpc Commands(CommandsRequest) returns (CommandsResponse) {}
  rpc Details(DetailsRequest) returns (DetailsResponse) {}
  rpc Run(stream RunRequest) returns (stream RunResponse) {}
}

// ListRequest is sent by the client to request a list of devices connected to the agent.
message ListRequest {}

// ListResponse is sent by the agent in response to a ListRequest.
message ListResponse {
  repeated string devices = 1;
}

// CommandsRequest is sent by the client to request a list of commands available for
// a specific device.
message CommandsRequest {
  string device = 1;
}

// CommandsResponse is sent by the agent in response to a CommandsRequest.
message CommandsResponse {
  repeated string commands = 1;
}

// DetailsRequest is sent by the client to request further information for specific
// device or a specific command. The type of information is defined by keyword.
message DetailsRequest {
  string device = 1;
  string cmd = 2;
  string keyword = 3;
}

// DetailsResponse is sent by the agent in response to a DetailsRequest.
message DetailsResponse {
  string details = 1;
}

// RunRequest is sent by the client to start a command execution on a device and optionally
// to further interact with the agent during the command execution.
// The first RunRequest message sent to a agent must always contain a Command message.
message RunRequest {
  oneof msg {
    Command command = 1;
    Console console = 2;
    FileTransferRequest file_transfer_request = 3;
    FileChunk file_chunk = 4;
    FileTransferResponse file_transfer_response = 5;
  }
}

// RunResponse is sent by the agent in response to a RunRequest and can either contain
// just the output of the command (Print), or trigger further interaction with the client.
message RunResponse {
  oneof msg {
    Print print = 1;
    Console console = 2;
    FileTransferRequest file_transfer_request = 3;
    FileChunk file_chunk = 4;
    FileTransferResponse file_transfer_response = 5;
  }
}

// Command is used by the client to start a command execution on a device.
message Command {
  string device = 1;
  string command = 2;
  repeated string args = 3;
}

// Print is used by the agent to send the output of a command execution to the client.
message Print {
  bytes text = 1;
}

// Console is used by the client and agent during an interactive command execution.
// An interactive session can only be started by the agent by sending the first Console message.
message Console {
  oneof data {
    bytes stdin = 1;
    bytes stdout = 2;
    bytes stderr = 3;
  }
}

// FileMetadata describes the properties of a file being transferred.
message FileMetadata {
  string path = 1;        // Path of the file
  int64 size = 2;         // Total file size in bytes
  string name = 3;        // Filename for reference
}

// FileChunk represents a single chunk of a file being transferred.
// Maximum chunk size is 1MB.
message FileChunk {
  string transfer_id = 1;     // Unique ID for this transfer session
  int32 chunk_number = 2;     // Sequential chunk number (0-indexed)
  bytes chunk_data = 3;       // File data chunk (max 1MB)
  int64 chunk_offset = 4;     // Byte offset in the file
  bool is_final = 5;          // Whether this is the last chunk
}

// FileTransferRequest initiates a file transfer.
// Sent by the side requesting to receive a file.
message FileTransferRequest {
  string transfer_id = 1;     // Unique ID for this transfer
  FileMetadata metadata = 2;  // File metadata
  
  enum Direction {
    DIRECTION_UNSPECIFIED = 0;
    UPLOAD = 1;               // Client sending file to agent (agent requesting from client)
    DOWNLOAD = 2;             // Agent sending file to client
  }
  Direction direction = 3;    // Direction of file transfer
}

// FileTransferResponse acknowledges file transfer requests and chunk receipts.
message FileTransferResponse {
  string transfer_id = 1;           // Matches request ID
  enum Status {
    STATUS_UNSPECIFIED = 0;
    ACCEPTED = 1;                   // Ready to receive chunks
    CHUNK_RECEIVED = 2;             // Chunk received successfully
    TRANSFER_COMPLETE = 3;          // All chunks received
    TRANSFER_REJECTED = 4;          // Transfer cannot proceed
    ERROR = 5;                      // Transfer error occurred
  }
  Status status = 2;
  int32 next_chunk_expected = 3;    // Next chunk number expected (for recovery)
  string error_message = 4;         // Error details if status is ERROR
}

// RelayService defines the service for forwarding communication via relay server.
// NOTE: This is an experimental service and may change in the future.
service RelayService {
  rpc Register(RegisterRequest) returns (RegisterResponse) {}
}

// RegisterRequest is sent by a device agent to register with the relay server.
// NOTE: This is an experimental service and may change in the future.
message RegisterRequest {
  repeated string devices = 1; // List of devices the agent is connected to.
  string address = 2; // Address of the agent sending the request.
}

// RegisterResponse is sent by the relay server in response to a successful RegisterRequest.
// NOTE: This is an experimental service and may change in the future.
message RegisterResponse {}
